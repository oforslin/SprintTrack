<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:SprintTrack.Converters"
             x:Class="SprintTrack.TrainingSessionDetailPage"
             x:Name="Page"
             Title="{Binding TrainingSession.DisplayName}"
             Shell.TabBarIsVisible="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
            <converters:ExerciseTypeToVisibilityConverter x:Key="ExerciseTypeToVisibilityConverter" />
            <converters:OrConverter x:Key="OrConverter" />
            <converters:IntegerOnlyBehavior x:Key="IntegerOnlyBehavior" />
            <converters:DecimalInputBehavior x:Key="DecimalInputBehavior" />
            <converters:BoolToWarmupColorConverter x:Key="BoolToWarmupColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <ScrollView>
            <StackLayout Padding="16" Spacing="16">
                
                <!-- Training Session Info -->
                <Frame BackgroundColor="#4A90E2" 
                       Padding="20" 
                       CornerRadius="12"
                       HasShadow="True">
                    <Grid RowSpacing="8">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0"
                               Text="{Binding TrainingSession.DisplayName}" 
                               FontSize="24" 
                               FontAttributes="Bold" 
                               TextColor="White"
                               HorizontalOptions="Center" />
                        
                        <Label Grid.Row="1"
                               Text="{Binding TrainingSession.Type}" 
                               FontSize="16" 
                               TextColor="White" 
                               HorizontalOptions="Center"
                               FontAttributes="Italic"
                               IsVisible="{Binding TrainingSession.Type, Converter={StaticResource StringToBoolConverter}}" />
                        
                        <Label Grid.Row="2"
                               Text="{Binding TrainingSession.Description}" 
                               FontSize="14" 
                               TextColor="White" 
                               HorizontalOptions="Center"
                               IsVisible="{Binding TrainingSession.Description, Converter={StaticResource StringToBoolConverter}}" />
                        
                        <Grid Grid.Row="3" ColumnSpacing="16" Margin="0,8,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <Label Grid.Column="0"
                                   Text="{Binding TrainingSession.Date, StringFormat='{0:yyyy-MM-dd}'}" 
                                   FontSize="14" 
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                            
                            <Label Grid.Column="1"
                                   Text="{Binding TrainingSession.DurationDisplay}" 
                                   FontSize="14" 
                                   TextColor="White"
                                   HorizontalOptions="Center" />
                        </Grid>
                        
                        <Label Grid.Row="4"
                               Text="{Binding TrainingSession.Intensity, StringFormat='Intensity: {0}/10'}" 
                               FontSize="14" 
                               TextColor="White"
                               HorizontalOptions="Center"
                               Margin="0,4,0,0" />
                    </Grid>
                </Frame>

                <!-- Add Exercise Button -->
                <Button Text="+ Add Exercise" 
                        Command="{Binding AddExerciseCommand}"
                        BackgroundColor="#28A745"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="48" />

                <!-- Exercises List -->
                <StackLayout Spacing="12">
                    <Label Text="Exercises" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           TextColor="#333"
                           Margin="0,8,0,8" />

                    <CollectionView ItemsSource="{Binding TrainingSession.Exercises}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame BackgroundColor="#F8F9FA" 
                                       Margin="0,6" 
                                       Padding="16"
                                       CornerRadius="12"
                                       HasShadow="True">
                                    <StackLayout Spacing="12">
                                        <!-- Exercise Header -->
                                        <Grid ColumnSpacing="8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <StackLayout Grid.Column="0" Spacing="4">
                                                <Label Text="{Binding Name}" 
                                                       FontAttributes="Bold" 
                                                       FontSize="18"
                                                       TextColor="#333" />
                                                <Label Text="{Binding ExerciseType}" 
                                                       FontSize="12" 
                                                       TextColor="#4A90E2"
                                                       FontAttributes="Italic" />
                                                <Label Text="{Binding Description}" 
                                                       FontSize="12" 
                                                       TextColor="#666"
                                                       IsVisible="{Binding Description, Converter={StaticResource StringToBoolConverter}}" />
                                            </StackLayout>

                                            <!-- Add Set Button for Strength -->
                                            <Button Grid.Column="1" 
                                                    Text="+ Set"
                                                    Command="{Binding Source={x:Reference Page}, Path=BindingContext.AddSetCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#28A745"
                                                    TextColor="White"
                                                    FontSize="10"
                                                    CornerRadius="6"
                                                    Padding="12,6"
                                                    Margin="4,0"
                                                    IsVisible="{Binding ExerciseType, Converter={StaticResource ExerciseTypeToVisibilityConverter}, ConverterParameter='Strength'}" />

                                            <!-- Add Set Button for Running types -->
                                            <Button Grid.Column="1" 
                                                    Text="+ Set"
                                                    Command="{Binding Source={x:Reference Page}, Path=BindingContext.AddRunningSetCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#28A745"
                                                    TextColor="White"
                                                    FontSize="10"
                                                    CornerRadius="6"
                                                    Padding="12,6"
                                                    Margin="4,0">
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{StaticResource OrConverter}">
                                                        <Binding Path="ExerciseType" Converter="{StaticResource ExerciseTypeToVisibilityConverter}" ConverterParameter="Running" />
                                                        <Binding Path="ExerciseType" Converter="{StaticResource ExerciseTypeToVisibilityConverter}" ConverterParameter="Sprinting" />
                                                        <Binding Path="ExerciseType" Converter="{StaticResource ExerciseTypeToVisibilityConverter}" ConverterParameter="SledSprint" />
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                            </Button>

                                            <Button Grid.Column="2" 
                                                    Text="Edit"
                                                    Command="{Binding Source={x:Reference Page}, Path=BindingContext.EditExerciseCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#FFC107"
                                                    TextColor="White"
                                                    FontSize="11"
                                                    CornerRadius="6"
                                                    Padding="12,6"
                                                    Margin="4,0" />

                                            <Button Grid.Column="3" 
                                                    Text="Delete"
                                                    Command="{Binding Source={x:Reference Page}, Path=BindingContext.DeleteExerciseCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#DC3545"
                                                    TextColor="White"
                                                    FontSize="11"
                                                    CornerRadius="6"
                                                    Padding="12,6"
                                                    Margin="4,0" />
                                        </Grid>

                                        <!-- Individual Sets for Strength Exercises -->
                                        <StackLayout IsVisible="{Binding ExerciseType, Converter={StaticResource ExerciseTypeToVisibilityConverter}, ConverterParameter='Strength'}"
                                                     Spacing="6">
                                            <CollectionView ItemsSource="{Binding ExerciseSets}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Frame BackgroundColor="White" 
                                                               Margin="0,3" 
                                                               Padding="8"
                                                               CornerRadius="8"
                                                               HasShadow="False"
                                                               BorderColor="#E9ECEF">
                                                            <Grid ColumnSpacing="6">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="50" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="32" />
                                                                </Grid.ColumnDefinitions>

                                                                <Button Grid.Column="0" 
                                                                        Text="{Binding SetDisplayText}" 
                                                                        FontAttributes="Bold"
                                                                        FontSize="11"
                                                                        TextColor="{Binding IsWarmupSet, Converter={StaticResource BoolToWarmupColorConverter}}"
                                                                        BackgroundColor="Transparent"
                                                                        BorderColor="Transparent"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.ToggleWarmupSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        HorizontalOptions="FillAndExpand"
                                                                        VerticalOptions="Center"
                                                                        Padding="0" />

                                                                <!-- Reps Section -->
                                                                <Grid Grid.Column="1" ColumnSpacing="3">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="20" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="20" />
                                                                    </Grid.ColumnDefinitions>
                                                                    
                                                                    <Button Grid.Column="0"
                                                                            Text="-"
                                                                            Command="{Binding Source={x:Reference Page}, Path=BindingContext.DecreaseRepsCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            BackgroundColor="#DC3545"
                                                                            TextColor="White"
                                                                            FontSize="10"
                                                                            WidthRequest="20"
                                                                            HeightRequest="20"
                                                                            CornerRadius="10" />

                                                                    <Entry Grid.Column="1" 
                                                                           Text="{Binding Reps}" 
                                                                           FontSize="11"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           BackgroundColor="Transparent"
                                                                           Placeholder="0"
                                                                           MaxLength="3"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:IntegerOnlyBehavior />
                                                                        </Entry.Behaviors>
                                                                    </Entry>

                                                                    <Button Grid.Column="2"
                                                                            Text="+"
                                                                            Command="{Binding Source={x:Reference Page}, Path=BindingContext.IncreaseRepsCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            BackgroundColor="#28A745"
                                                                            TextColor="White"
                                                                            FontSize="10"
                                                                            WidthRequest="20"
                                                                            HeightRequest="20"
                                                                            CornerRadius="10" />
                                                                </Grid>

                                                                <!-- Weight Section -->
                                                                <Grid Grid.Column="2" ColumnSpacing="3">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="20" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="20" />
                                                                    </Grid.ColumnDefinitions>
                                                                    
                                                                    <Button Grid.Column="0"
                                                                            Text="-"
                                                                            Command="{Binding Source={x:Reference Page}, Path=BindingContext.DecreaseWeightCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            BackgroundColor="#DC3545"
                                                                            TextColor="White"
                                                                            FontSize="10"
                                                                            WidthRequest="20"
                                                                            HeightRequest="20"
                                                                            CornerRadius="10" />

                                                                    <Entry Grid.Column="1" 
                                                                           Text="{Binding Weight}" 
                                                                           FontSize="11"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           BackgroundColor="Transparent"
                                                                           Placeholder="0.0"
                                                                           MaxLength="6"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:DecimalInputBehavior MaxDecimalPlaces="2" />
                                                                        </Entry.Behaviors>
                                                                    </Entry>

                                                                    <Button Grid.Column="2"
                                                                            Text="+"
                                                                            Command="{Binding Source={x:Reference Page}, Path=BindingContext.IncreaseWeightCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            BackgroundColor="#28A745"
                                                                            TextColor="White"
                                                                            FontSize="10"
                                                                            WidthRequest="20"
                                                                            HeightRequest="20"
                                                                            CornerRadius="10" />
                                                                </Grid>

                                                                <Button Grid.Column="3"
                                                                        Text="×"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.RemoveSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        BackgroundColor="#DC3545"
                                                                        TextColor="White"
                                                                        FontSize="12"
                                                                        WidthRequest="28"
                                                                        HeightRequest="28"
                                                                        CornerRadius="14" />
                                                            </Grid>
                                                        </Frame>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </StackLayout>

                                        <!-- Running Exercise Display -->
                                        <StackLayout IsVisible="{Binding ExerciseType, Converter={StaticResource ExerciseTypeToVisibilityConverter}, ConverterParameter='Running'}" 
                                                     Spacing="6">
                                            <CollectionView ItemsSource="{Binding RunningSets}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Frame BackgroundColor="White" 
                                                               Margin="0,3" 
                                                               Padding="8"
                                                               CornerRadius="8"
                                                               HasShadow="False"
                                                               BorderColor="#E9ECEF">
                                                            <Grid ColumnSpacing="8">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="50" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="32" />
                                                                </Grid.ColumnDefinitions>

                                                                <Button Grid.Column="0" 
                                                                        Text="{Binding SetDisplayText}" 
                                                                        FontAttributes="Bold"
                                                                        FontSize="11"
                                                                        TextColor="{Binding IsWarmupSet, Converter={StaticResource BoolToWarmupColorConverter}}"
                                                                        BackgroundColor="Transparent"
                                                                        BorderColor="Transparent"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.ToggleWarmupRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        HorizontalOptions="FillAndExpand"
                                                                        VerticalOptions="Center"
                                                                        Padding="0" />

                                                                <StackLayout Grid.Column="1" Spacing="2">
                                                                    <Label Text="Time (HH:MM:SS)" FontSize="9" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Grid ColumnSpacing="1">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="28" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="28" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="28" />
                                                                        </Grid.ColumnDefinitions>
                                                                        <Entry Grid.Column="0" 
                                                                               Text="{Binding DurationHours}" 
                                                                               FontSize="10" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                        <Label Grid.Column="1" 
                                                                               Text=":" 
                                                                               VerticalOptions="Center" 
                                                                               HorizontalOptions="Center"
                                                                               FontSize="12"
                                                                               FontAttributes="Bold" />
                                                                        <Entry Grid.Column="2" 
                                                                               Text="{Binding DurationMinutes}" 
                                                                               FontSize="10" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                        <Label Grid.Column="3" 
                                                                               Text=":" 
                                                                               VerticalOptions="Center" 
                                                                               HorizontalOptions="Center"
                                                                               FontSize="12"
                                                                               FontAttributes="Bold" />
                                                                        <Entry Grid.Column="4" 
                                                                               Text="{Binding DurationSeconds}" 
                                                                               FontSize="10" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                    </Grid>
                                                                </StackLayout>

                                                                <StackLayout Grid.Column="2" Spacing="2">
                                                                    <Label Text="Distance (km)" FontSize="9" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Entry Text="{Binding Distance}" 
                                                                           FontSize="10"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           MaxLength="6"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:DecimalInputBehavior MaxDecimalPlaces="2" />
                                                                        </Entry.Behaviors>
                                                                    </Entry>
                                                                </StackLayout>

                                                                <Button Grid.Column="3"
                                                                        Text="×"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.RemoveRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        BackgroundColor="#DC3545"
                                                                        TextColor="White"
                                                                        FontSize="12"
                                                                        WidthRequest="28"
                                                                        HeightRequest="28"
                                                                        CornerRadius="14" />
                                                            </Grid>
                                                        </Frame>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </StackLayout>

                                        <!-- Sprinting Exercise Display -->
                                        <StackLayout IsVisible="{Binding ExerciseType, Converter={StaticResource ExerciseTypeToVisibilityConverter}, ConverterParameter='Sprinting'}" 
                                                     Spacing="6">
                                            <CollectionView ItemsSource="{Binding RunningSets}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Frame BackgroundColor="White" 
                                                               Margin="0,3" 
                                                               Padding="8"
                                                               CornerRadius="8"
                                                               HasShadow="False"
                                                               BorderColor="#E9ECEF">
                                                            <Grid ColumnSpacing="8">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="50" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="32" />
                                                                </Grid.ColumnDefinitions>

                                                                <Button Grid.Column="0" 
                                                                        Text="{Binding SetDisplayText}" 
                                                                        FontAttributes="Bold"
                                                                        FontSize="11"
                                                                        TextColor="{Binding IsWarmupSet, Converter={StaticResource BoolToWarmupColorConverter}}"
                                                                        BackgroundColor="Transparent"
                                                                        BorderColor="Transparent"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.ToggleWarmupRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        HorizontalOptions="FillAndExpand"
                                                                        VerticalOptions="Center"
                                                                        Padding="0" />

                                                                <StackLayout Grid.Column="1" Spacing="2">
                                                                    <Label Text="Time (s.hs)" FontSize="9" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Grid ColumnSpacing="1">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="28" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="28" />
                                                                        </Grid.ColumnDefinitions>
                                                                        <Entry Grid.Column="0" 
                                                                               Text="{Binding SprintSeconds}" 
                                                                               FontSize="10" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                        <Label Grid.Column="1" 
                                                                               Text="." 
                                                                               VerticalOptions="Center" 
                                                                               HorizontalOptions="Center"
                                                                               FontSize="12"
                                                                               FontAttributes="Bold" />
                                                                        <Entry Grid.Column="2" 
                                                                               Text="{Binding SprintHundredths}" 
                                                                               FontSize="10" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                    </Grid>
                                                                </StackLayout>

                                                                <StackLayout Grid.Column="2" Spacing="2">
                                                                    <Label Text="Distance (m)" FontSize="9" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Entry Text="{Binding Distance}" 
                                                                           FontSize="10"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           MaxLength="5"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:IntegerOnlyBehavior />
                                                                        </Entry.Behaviors>
                                                                    </Entry>
                                                                </StackLayout>

                                                                <Button Grid.Column="3"
                                                                        Text="×"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.RemoveRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        BackgroundColor="#DC3545"
                                                                        TextColor="White"
                                                                        FontSize="12"
                                                                        WidthRequest="28"
                                                                        HeightRequest="28"
                                                                        CornerRadius="14" />
                                                            </Grid>
                                                        </Frame>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </StackLayout>

                                        <!-- Sled Sprint Exercise Display -->
                                        <StackLayout IsVisible="{Binding ExerciseType, Converter={StaticResource ExerciseTypeToVisibilityConverter}, ConverterParameter='SledSprint'}" 
                                                     Spacing="6">
                                            <CollectionView ItemsSource="{Binding RunningSets}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Frame BackgroundColor="White" 
                                                               Margin="0,3" 
                                                               Padding="8"
                                                               CornerRadius="8"
                                                               HasShadow="False"
                                                               BorderColor="#E9ECEF">
                                                            <Grid ColumnSpacing="6">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="40" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="32" />
                                                                </Grid.ColumnDefinitions>

                                                                <Button Grid.Column="0" 
                                                                        Text="{Binding SetDisplayText}" 
                                                                        FontAttributes="Bold"
                                                                        FontSize="10"
                                                                        TextColor="{Binding IsWarmupSet, Converter={StaticResource BoolToWarmupColorConverter}}"
                                                                        BackgroundColor="Transparent"
                                                                        BorderColor="Transparent"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.ToggleWarmupRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        HorizontalOptions="FillAndExpand"
                                                                        VerticalOptions="Center"
                                                                        Padding="0" />

                                                                <StackLayout Grid.Column="1" Spacing="1">
                                                                    <Label Text="Time (s.hs)" FontSize="8" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Grid ColumnSpacing="1">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="28" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="28" />
                                                                        </Grid.ColumnDefinitions>
                                                                        <Entry Grid.Column="0" 
                                                                               Text="{Binding SprintSeconds}" 
                                                                               FontSize="9" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                        <Label Grid.Column="1" 
                                                                               Text="." 
                                                                               VerticalOptions="Center" 
                                                                               HorizontalOptions="Center"
                                                                               FontSize="10" />
                                                                        <Entry Grid.Column="2" 
                                                                               Text="{Binding SprintHundredths}" 
                                                                               FontSize="9" 
                                                                               HorizontalTextAlignment="Center"
                                                                               VerticalTextAlignment="Center"
                                                                               Keyboard="Numeric" 
                                                                               Placeholder="00"
                                                                               MaxLength="2"
                                                                               TextChanged="OnTimeEntryTextChanged"
                                                                               Unfocused="OnEntryUnfocused">
                                                                            <Entry.Behaviors>
                                                                                <converters:IntegerOnlyBehavior />
                                                                            </Entry.Behaviors>
                                                                        </Entry>
                                                                    </Grid>
                                                                </StackLayout>

                                                                <StackLayout Grid.Column="2" Spacing="2">
                                                                    <Label Text="Dist (m)" FontSize="8" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Entry Text="{Binding Distance}" 
                                                                           FontSize="9"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           MaxLength="5"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:IntegerOnlyBehavior />
                                                                        </Entry.Behaviors>
                                                                    </Entry>
                                                                </StackLayout>

                                                                <StackLayout Grid.Column="3" Spacing="1">
                                                                    <Label Text="Vikt (kg)" FontSize="8" TextColor="#666" HorizontalOptions="Center" />
                                                                    <Entry Text="{Binding Weight}" 
                                                                           FontSize="9"
                                                                           HorizontalTextAlignment="Center"
                                                                           VerticalTextAlignment="Center"
                                                                           Keyboard="Numeric"
                                                                           MaxLength="6"
                                                                           Unfocused="OnEntryUnfocused">
                                                                        <Entry.Behaviors>
                                                                            <converters:DecimalInputBehavior MaxDecimalPlaces="2" />
                                                                        </Entry.Behaviors>
                                                                    </Entry>
                                                                </StackLayout>

                                                                <Button Grid.Column="4"
                                                                        Text="×"
                                                                        Command="{Binding Source={x:Reference Page}, Path=BindingContext.RemoveRunningSetCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        BackgroundColor="#DC3545"
                                                                        TextColor="White"
                                                                        FontSize="12"
                                                                        WidthRequest="28"
                                                                        HeightRequest="28"
                                                                        CornerRadius="14" />
                                                            </Grid>
                                                        </Frame>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </StackLayout>
                                    </StackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>

                <!-- Back Button -->
                <Button Text="? Tillbaka" 
                        Command="{Binding BackCommand}"
                        BackgroundColor="#6C757D"
                        TextColor="White"
                        FontSize="16"
                        CornerRadius="8"
                        HeightRequest="48"
                        Margin="0,16,0,0" />

            </StackLayout>
        </ScrollView>

        <!-- Add Exercise Popup -->
        <Frame IsVisible="{Binding IsAddingExercise}"
               BackgroundColor="White"
               BorderColor="#DEE2E6"
               HasShadow="True"
               Padding="24"
               Margin="20"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               WidthRequest="500"
               MaximumHeightRequest="700"
               CornerRadius="16">
            
            <ScrollView>
                <StackLayout Spacing="20">
                    <Grid ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <Label Grid.Column="0"
                               Text="Add Exercise" 
                               FontSize="22" 
                               FontAttributes="Bold" 
                               TextColor="#333"
                               VerticalOptions="Center" />
                        
                        <Button Grid.Column="1"
                                Text="�"
                                Command="{Binding CancelAddExerciseCommand}"
                                BackgroundColor="#DC3545"
                                TextColor="White"
                                FontSize="16"
                                WidthRequest="32"
                                HeightRequest="32"
                                CornerRadius="16" />
                    </Grid>
                    
                    <!-- Step 1: Exercise Selection -->
                    <StackLayout Spacing="8">
                        <Label Text="Step 1: Choose Exercise" 
                               FontSize="16" 
                               FontAttributes="Bold" 
                               TextColor="#4A90E2" />
                        
                        <Grid RowSpacing="8">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="180" />
                            </Grid.RowDefinitions>
                            
                            <!-- Search Entry -->
                            <Entry Grid.Row="0"
                                   Placeholder="Search exercises..." 
                                   Text="{Binding ExerciseSearchText}" 
                                   FontSize="14"
                                   x:Name="ExerciseEntry"
                                   Focused="OnExerciseEntryFocused"
                                   BackgroundColor="#F8F9FA"
                                   PlaceholderColor="#6C757D" />
                            
                            <!-- Exercise List -->
                            <Frame Grid.Row="1" 
                                   BackgroundColor="White"
                                   BorderColor="#DEE2E6"
                                   Padding="8"
                                   CornerRadius="8"
                                   Margin="0,4,0,0">
                                <CollectionView ItemsSource="{Binding CommonExercises}"
                                                SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="12,8" 
                                                  BackgroundColor="White">
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.SelectExerciseCommand}"
                                                                          CommandParameter="{Binding Name}" />
                                                </Grid.GestureRecognizers>
                                                
                                                <Frame BackgroundColor="#E3F2FD"
                                                       Padding="12"
                                                       CornerRadius="8"
                                                       BorderColor="#BBDEFB"
                                                       HasShadow="False">
                                                    <StackLayout Spacing="4">
                                                        <Label Text="{Binding Name}" 
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="#1976D2" />
                                                        <StackLayout Orientation="Horizontal" Spacing="4">
                                                            <Label Text="{Binding Type}" 
                                                                   FontSize="10"
                                                                   TextColor="#1976D2"
                                                                   FontAttributes="Bold" />
                                                            <Label Text=" - " 
                                                                   FontSize="10"
                                                                   TextColor="#666" />
                                                            <Label Text="{Binding Description}" 
                                                                   FontSize="10"
                                                                   TextColor="#666" />
                                                        </StackLayout>
                                                    </StackLayout>
                                                </Frame>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Frame>
                        </Grid>
                    </StackLayout>
                    
                    <!-- Step 2: Selected Exercise Display -->
                    <StackLayout IsVisible="{Binding NewExerciseName, Converter={StaticResource StringToBoolConverter}}" 
                                 Spacing="16">
                        <Label Text="Step 2: Configure Exercise" 
                               FontSize="16" 
                               FontAttributes="Bold" 
                               TextColor="#4A90E2" />
                        
                        <Frame BackgroundColor="#D4EDDA" 
                               Padding="16"
                               CornerRadius="8"
                               BorderColor="#C3E6CB"
                               HasShadow="False">
                            <StackLayout Spacing="4">
                                <Label Text="{Binding NewExerciseName}" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="#155724" />
                                <Label Text="{Binding NewExerciseType, StringFormat='Type: {0}'}" 
                                       FontSize="14" 
                                       TextColor="#155724" />
                            </StackLayout>
                        </Frame>
                        
                        <!-- Description -->
                        <StackLayout Spacing="8">
                            <Label Text="Description/Comment (optional)" 
                                   FontSize="14" 
                                   TextColor="#666" />
                            <Editor Text="{Binding NewExerciseDescription}" 
                                    HeightRequest="60"
                                    FontSize="14"
                                    BackgroundColor="#F8F9FA" />
                        </StackLayout>
                        
                        <!-- Strength Exercise Sets Configuration -->
                        <StackLayout IsVisible="{Binding IsStrengthExercise}" 
                                     Spacing="12">
                            <Grid ColumnSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <StackLayout Grid.Column="0" VerticalOptions="Center">
                                    <Label Text="Sets Configuration" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="#666" />
                                </StackLayout>
                                
                                <Button Grid.Column="1"
                                        Text="+ Add Set"
                                        Command="{Binding AddNewSetCommand}"
                                        BackgroundColor="#28A745"
                                        TextColor="White"
                                        FontSize="12"
                                        CornerRadius="6"
                                        Padding="12,8" />
                            </Grid>
                            
                            <!-- Individual Sets -->
                            <CollectionView ItemsSource="{Binding NewExerciseSetsList}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Frame BackgroundColor="White" 
                                               BorderColor="#DEE2E6"
                                               Margin="0,4" 
                                               Padding="8"
                                               CornerRadius="8"
                                               HasShadow="False">
                                            <Grid ColumnSpacing="6">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="50" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="32" />
                                                </Grid.ColumnDefinitions>

                                                <Button Grid.Column="0" 
                                                        Text="{Binding SetDisplayText}" 
                                                        FontAttributes="Bold"
                                                        FontSize="11"
                                                        TextColor="{Binding IsWarmupSet, Converter={StaticResource BoolToWarmupColorConverter}}"
                                                        BackgroundColor="Transparent"
                                                        BorderColor="Transparent"
                                                        Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.ToggleNewWarmupSetCommand}"
                                                        CommandParameter="{Binding .}"
                                                        HorizontalOptions="FillAndExpand"
                                                        VerticalOptions="Center"
                                                        Padding="0" />

                                                <!-- Reps Section -->
                                                <Grid Grid.Column="1" ColumnSpacing="3">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="20" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="20" />
                                                    </Grid.ColumnDefinitions>
                                                
                                                    <Button Grid.Column="0"
                                                            Text="-"
                                                            Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.DecreaseNewRepsCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#DC3545"
                                                            TextColor="White"
                                                            FontSize="10"
                                                            WidthRequest="20"
                                                            HeightRequest="20"
                                                            CornerRadius="10" />

                                                    <Entry Grid.Column="1" 
                                                           Text="{Binding Reps}" 
                                                           FontSize="11"
                                                           HorizontalTextAlignment="Center"
                                                           VerticalTextAlignment="Center"
                                                           Keyboard="Numeric"
                                                           BackgroundColor="Transparent"
                                                           Placeholder="0"
                                                           MaxLength="3"
                                                           Unfocused="OnEntryUnfocused">
                                                        <Entry.Behaviors>
                                                            <converters:IntegerOnlyBehavior />
                                                        </Entry.Behaviors>
                                                    </Entry>

                                                    <Button Grid.Column="2"
                                                            Text="+"
                                                            Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.IncreaseNewRepsCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#28A745"
                                                            TextColor="White"
                                                            FontSize="10"
                                                            WidthRequest="20"
                                                            HeightRequest="20"
                                                            CornerRadius="10" />
                                                </Grid>

                                                <!-- Weight Section -->
                                                <Grid Grid.Column="2" ColumnSpacing="3">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="20" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="20" />
                                                    </Grid.ColumnDefinitions>
                                                
                                                    <Button Grid.Column="0"
                                                            Text="-"
                                                            Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.DecreaseNewWeightCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#DC3545"
                                                            TextColor="White"
                                                            FontSize="10"
                                                            WidthRequest="20"
                                                            HeightRequest="20"
                                                            CornerRadius="10" />

                                                    <Entry Grid.Column="1" 
                                                           Text="{Binding Weight}" 
                                                           FontSize="11"
                                                           HorizontalTextAlignment="Center"
                                                           VerticalTextAlignment="Center"
                                                           Keyboard="Numeric"
                                                           BackgroundColor="Transparent"
                                                           Placeholder="0.0"
                                                           MaxLength="6"
                                                           Unfocused="OnEntryUnfocused">
                                                        <Entry.Behaviors>
                                                            <converters:DecimalInputBehavior MaxDecimalPlaces="2" />
                                                        </Entry.Behaviors>
                                                    </Entry>

                                                    <Button Grid.Column="2"
                                                            Text="+"
                                                            Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.IncreaseNewWeightCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="#28A745"
                                                            TextColor="White"
                                                            FontSize="10"
                                                            WidthRequest="20"
                                                            HeightRequest="20"
                                                            CornerRadius="10" />
                                                </Grid>

                                                <Button Grid.Column="3"
                                                        Text="×"
                                                        Command="{Binding Source={x:Reference ExerciseEntry}, Path=BindingContext.RemoveNewSetCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#DC3545"
                                                        TextColor="White"
                                                        FontSize="12"
                                                        WidthRequest="28"
                                                        HeightRequest="28"
                                                        CornerRadius="14" />
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </StackLayout>
                        
                        <!-- Action Buttons -->
                        <Grid Margin="0,20,0,0" ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <Button Grid.Column="0" 
                                    Text="Cancel" 
                                    Command="{Binding CancelAddExerciseCommand}"
                                    BackgroundColor="#6C757D"
                                    TextColor="White"
                                    FontSize="14"
                                    CornerRadius="8"
                                    HeightRequest="44" />
                            
                            <Button Grid.Column="1" 
                                    Text="Add Exercise" 
                                    Command="{Binding SaveExerciseCommand}"
                                    BackgroundColor="#28A745" 
                                    TextColor="White"
                                    FontSize="14"
                                    FontAttributes="Bold"
                                    CornerRadius="8"
                                    HeightRequest="44" />
                        </Grid>
                    </StackLayout>
                </StackLayout>
            </ScrollView>
        </Frame>

        <!-- Background overlay for popup -->
        <Grid IsVisible="{Binding IsAddingExercise}"
              BackgroundColor="Black"
              Opacity="0.6"
              ZIndex="-1">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CancelAddExerciseCommand}" />
            </Grid.GestureRecognizers>
        </Grid>
    </Grid>

</ContentPage>